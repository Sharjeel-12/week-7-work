<h2 class="section-title">Patients</h2>

<!-- Toolbar: Search + Page size -->
<div class="toolbar" style="display:flex; gap:24px; align-items:flex-end; margin-bottom:12px;">
  <div>
    <label for="search-field">Search patient record here</label><br/>
    <input
      type="text"
      id="search-field"
      placeholder="Search by ID, name, email, or phone..."
      [formControl]="searchFC"
      style="min-width:320px;"
    />
  </div>

  <div>
    <label for="page-size">Records per page</label><br/>
<select id="pageSize" [value]="pageSize" (change)="changePageSize(($any($event.target).value))">
  @for (sz of pageSizeOptions; track sz) {
    <option [value]="sz">{{ sz }}</option>
  }
</select>
  </div>
</div>

<button (click)="activateForm()" class="add-btn">+Add New Patient</button>

@if(AddBtnPressed){
  <form [formGroup]="addPatientForm" (ngSubmit)="onSubmit()" id="addPatientForm" class="patient-form">
    <div>
      <label for="patientID">Patient ID</label><br/>
      <input formControlName="patientID" type="number" id="patientID" name="patientID" />
      @if(AddForm['patientID'].touched && AddForm['patientID'].invalid){
        <div class="err-msg">Enter a valid patient ID</div>
      }
    </div>

    <div>
      <label for="patientName">Patient Name</label><br/>
      <input formControlName="patientName" type="text" id="patientName" name="patientName" />
      @if(AddForm['patientName'].touched && AddForm['patientName'].invalid){
        <div class="err-msg">Enter a valid patient Name</div>
      }
    </div>

    <div>
      <label for="patientEmail">Patient Email</label><br/>
      <input formControlName="patientEmail" type="text" id="patientEmail" name="patientEmail" />
      @if(AddForm['patientEmail'].touched && AddForm['patientEmail'].invalid){
        @if(AddForm['patientEmail'].errors?.["required"]){
          <div class="err-msg">Username is required</div>
        }
        @if(AddForm['patientEmail'].errors?.["minlength"]){
          <div class="err-msg">Username must be at least {{AddForm['patientEmail'].errors?.['minlength'].requiredLength}} characters.</div>
        }
      }
    </div>

    <div>
      <label for="patientPhone">Patient Phone</label><br/>
      <input formControlName="patientPhone" type="text" id="patientPhone" name="patientPhone" />
      @if(AddForm['patientPhone'].touched && AddForm['patientPhone'].invalid){
        <div class="err-msg">Enter a valid patient Phone</div>
      }
    </div>

    <div>
      <label for="patientDescription">Patient Description</label><br/>
      <textarea formControlName="patientDescription" id="patientDescription" name="patientDescription"></textarea>
    </div>

    <div>
      <button [disabled]="!(addPatientForm.valid)" type="submit">Add Patient</button>
      <button type="button" (click)="deactivateForm()">cancel</button>
    </div>
  </form>
}

@if(showDuplicatePanel){
  <div class="dup-panel" style="margin:16px 0; padding:12px; border:1px solid #ddd; border-radius:8px; background:#fffaf0;">
    <h3 style="margin:0 0 8px;">Possible duplicate(s) found</h3>
    <p style="margin:0 0 8px;">
      We found records that might match the patient you’re adding. Review and choose an action.
      @if(hardDuplicate){
        <strong style="color:#b00020;">A hard conflict was found (same ID/email/phone). Submitting is disabled.</strong>
      }
    </p>

    <table class="patients-table">
      <thead>
        <tr>
          <th>Score</th>
          <th>Patient ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Why suggested</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (c of duplicateCandidates; track c.patient.patientID) {
          <tr>
            <td>{{ (c.score * 100) | number:'1.0-0' }}%</td>
            <td>{{ c.patient.patientID }}</td>
            <td>{{ c.patient.patientName }}</td>
            <td>{{ c.patient.patientEmail }}</td>
            <td>{{ c.patient.patientPhone }}</td>
            <td>
              <ul style="margin:0; padding-left:18px;">
                @for (r of c.reasons; track r) {
                  <li>{{ r }}</li>
                }
              </ul>
            </td>
            <td>
              <button type="button" (click)="useExisting(c.patient)">Open existing</button>
            </td>
          </tr>
        }
      </tbody>
    </table>

    <div style="display:flex; gap:8px; margin-top:10px;">
      <button type="button" (click)="proceedAddAnyway()" [disabled]="hardDuplicate">Submit anyway</button>
      <button type="button" (click)="cancelDuplicatePanel()">Cancel</button>
    </div>
  </div>
}


@if(EditBtnPressed){
  <form [formGroup]="editPatientForm" (ngSubmit)="onEdit()" id="editPatientForm" class="patient-form">
    <div>
      <label for="patientID">Patient ID</label><br/>
      <input formControlName="patientID" type="number" id="patientID" name="patientID" />
      @if(EditForm['patientID'].touched && EditForm['patientID'].invalid){
        <div class="err-msg">Enter a valid patient ID</div>
      }
    </div>

    <div>
      <label for="visitID">Visit ID</label><br/>
      <input formControlName="visitID" type="number" id="visitID" name="visitID" />
    </div>

    <div>
      <label for="patientName">Patient Name</label><br/>
      <input formControlName="patientName" type="text" id="patientName" name="patientName" />
      @if(EditForm['patientName'].touched && EditForm['patientName'].invalid){
        <div class="err-msg">Enter a valid patient Name</div>
      }
    </div>

    <div>
      <label for="patientEmail">Patient Email</label><br/>
      <input formControlName="patientEmail" type="text" id="patientEmail" name="patientEmail" />
      @if(EditForm['patientEmail'].touched && EditForm['patientEmail'].invalid){
        @if(EditForm['patientEmail'].errors?.["required"]){
          <div class="err-msg">Username is required</div>
        }
        @if(EditForm['patientEmail'].errors?.["minlength"]){
          <div class="err-msg">Username must be at least {{EditForm['patientEmail'].errors?.['minlength'].requiredLength}} characters.</div>
        }
      }
    </div>

    <div>
      <label for="patientPhone">Patient Phone</label><br/>
      <input formControlName="patientPhone" type="text" id="patientPhone" name="patientPhone" />
      @if(EditForm['patientPhone'].touched && EditForm['patientPhone'].invalid){
        <div class="err-msg">this can't be blank</div>
      }
    </div>

    <div>
      <label for="patientDescription">Patient Description</label><br/>
      <textarea formControlName="patientDescription" id="patientDescription" name="patientDescription"></textarea>
    </div>

    <div>
      <button [disabled]="!(editPatientForm.valid)" type="submit">Edit Patient Record</button>
      <button type="button" (click)="deactivateEditForm()">cancel</button>
    </div>
  </form>
}

<table class="patients-table">
  <thead>
    <tr>
      <th (click)="onSort('patientID')"          style="cursor:pointer">Patient ID {{sortArrow('patientID')}}</th>
      <th (click)="onSort('patientName')"        style="cursor:pointer">Patient Name {{sortArrow('patientName')}}</th>
      <th (click)="onSort('patientEmail')"       style="cursor:pointer">Patient Email {{sortArrow('patientEmail')}}</th>
      <th (click)="onSort('patientPhone')"       style="cursor:pointer">Patient Phone {{sortArrow('patientPhone')}}</th>
      <th (click)="onSort('patientDescription')" style="cursor:pointer">Patient Description {{sortArrow('patientDescription')}}</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    @for(patient of visiblePatients; track patient){
      <tr>
        <td>{{patient.patientID}}</td>
        <td>{{patient.patientName}}</td>
        <td>{{patient.patientEmail}}</td>
        <td>{{patient.patientPhone}}</td>
        <td>{{patient.patientDescription}}</td>
        <td class="actions">
          <button type="button" class="btn btn-edit" (click)="activateEditForm(patient)">Edit</button>
          <button type="button" class="btn btn-delete" (click)="deleteAction(patient.patientID)">Delete</button>
        </td>
      </tr>
    }
  </tbody>
</table>

<!-- Pager -->
<div class="pager" style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
  <div class="pager-info">
    Showing
    {{ total === 0 ? 0 : ( (page - 1) * pageSize + 1 ) }}
    –
    {{ math.min(page * pageSize, total) }}
    of {{ total }}
  </div>
  <div class="pager-controls" style="display:flex; gap:6px; align-items:center;">
    <button (click)="goToPage(1)" [disabled]="page === 1">First</button>
    <button (click)="prevPage()"  [disabled]="page === 1">Prev</button>
    <span>Page {{page}} / {{ math.max(1, math.ceil(total / pageSize)) }}</span>
    <button (click)="nextPage()"  [disabled]="page >= math.ceil(total / pageSize)">Next ›</button>
    <button (click)="goToPage(math.ceil(total / pageSize))" [disabled]="page >= math.ceil(total / pageSize)">Last »</button>
  </div>
</div>
